package juc;

import java.util.Random;
import java.util.concurrent.*;

public class LinkedBlockingQueueExample {

    private static Random random = new Random();

    private static ThreadLocalRandom threadLocalRandom = ThreadLocalRandom.current();


    //é»˜è®¤æ— ç•Œï¼ˆä½†å¯ä»¥æŒ‡å®šå¤§å°ï¼‰
    static  BlockingQueue<String> queue = new LinkedBlockingQueue<>(1000);


    private static final int times = 100;  //å¾ªç¯æ¬¡æ•°

    private static final int threads = 200; // çº¿ç¨‹æ•°é‡

    static final CountDownLatch  latch = new CountDownLatch(threads ); // ä¸€å…±å¯åŠ¨äº† threads*2 ä¸ªçº¿ç¨‹

    public static void main(String[] args) throws InterruptedException {



        long startTime = System.currentTimeMillis();
        for (int i = 0; i < threads; i++) {
            new producerThread().start();
            consumerThread consumerThread = new consumerThread();
            consumerThread.setPriority(6);  //ä¼˜å…ˆçº§ï¼Œæœ€å°æ˜¯5  é»˜è®¤æ˜¯5  æœ€é«˜10
            consumerThread.start();
        }


        latch.await(); // ä¸»çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰å­çº¿ç¨‹ countDown

        long endTime = System.currentTimeMillis();

        System.out.println("ç”¨æ—¶:"+(endTime - startTime));

        System.out.println("æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼");
    }


    /**
     * ç”Ÿäº§è€…çº¿ç¨‹
     */
    static class producerThread extends Thread {
        @Override
        public void run() {
            for (int i = 0; i < times; i++) {
//                String message = String.valueOf(threadLocalRandom.nextInt());
                String message = String.valueOf(random.nextInt(100));
                System.out.println(Thread.currentThread().getName()+"çº¿ç¨‹åœ¨ç”Ÿäº§ä¿¡æ¯ï¼š"+message);

                try {
                    queue.put(message);
                }catch (Exception e) {
                    System.out.println("æ’å…¥å¤±è´¥");
                    e.printStackTrace();
                }

                try {
                    Thread.sleep(1000);
                }catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }

            latch.countDown(); // å…³é”®ï¼ï¼å‘Šè¯‰ä¸»çº¿ç¨‹â€œæˆ‘ç»“æŸäº†â€
        }
    }

    static class consumerThread extends Thread {
        @Override
        public void run() {
            while (true) {

                String message = null;
                try {
                    message = queue.poll(5, TimeUnit.SECONDS);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                if(message != null) {
                    System.out.println("çº¿ç¨‹"+Thread.currentThread().getName()+"æ­£åœ¨æ¶ˆè´¹ä¿¡æ¯:"+message);
                }
                else {
                    try {
                        Thread.sleep(20);
                    }catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        }
    }
}
/**
 * éå¸¸å¥½ï¼ä½ ä¸åªæ˜¯æƒ³çŸ¥é“æ–¹æ³•æ€ä¹ˆç”¨ï¼Œè¿˜æƒ³çŸ¥é“**æ¯ç§æ–¹æ³•çš„ç‰¹æ€§ã€ä¼šä¸ä¼šé˜»å¡ã€æœ‰å•¥å‘ã€æœ‰å•¥ä¼˜ç¼ºç‚¹**ï¼Œæˆ‘æ¥ç³»ç»Ÿåœ°å¸®ä½ æ¢³ç†ä¸‹ `LinkedBlockingQueue` çš„æ ¸å¿ƒç”¨æ³•å’Œåº•å±‚ç‰¹ç‚¹ï¼Œç¡®ä¿ä½ ç”¨äº†å°±ç†è§£é€ã€‚
 *
 * ---
 *
 * ## ğŸ” ä¸€ã€é˜Ÿåˆ—åŸºæœ¬ç‰¹æ€§ï¼ˆLinkedBlockingQueueï¼‰
 *
 * * **åŸºäºé“¾è¡¨ç»“æ„**ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸åƒ `ArrayBlockingQueue` é‚£æ ·ç”¨æ•°ç»„ã€‚
 * * **å®¹é‡æœ‰é™**ï¼Œé»˜è®¤æœ€å¤§æ˜¯ `Integer.MAX_VALUE`ï¼Œå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•ä¼ å®¹é‡ã€‚
 * * **çº¿ç¨‹å®‰å…¨**ï¼Œå…¥é˜Ÿå’Œå‡ºé˜Ÿå„è‡ªç”¨ä¸€æŠŠé”ï¼Œ**æ”¯æŒå¹¶å‘çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åŒæ—¶è¿›è¡Œ**ã€‚
 * * **å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰** é¡ºåºã€‚
 *
 * ---
 *
 * ## ğŸ§  äºŒã€æ–¹æ³•åˆ†ç±» + ä½¿ç”¨ç‰¹æ€§åˆ†æï¼ˆä¼˜ç¼ºç‚¹è¯´æ˜ï¼‰
 *
 * ### ğŸŸ© å…¥é˜Ÿæ–¹æ³•ï¼ˆæ·»åŠ å…ƒç´ ï¼‰
 *
 * | æ–¹æ³•                          | é˜»å¡æ€§    | ç‰¹æ€§                              | æ˜¯å¦æ¨è          | å¯èƒ½çš„é—®é¢˜                | ä¼˜ç‚¹          |
 * | --------------------------- | ------ | ------------------------------- | ------------- | -------------------- | ----------- |
 * | `add(E e)`                  | âŒ éé˜»å¡  | æ»¡äº†å°±æŠ›å¼‚å¸¸ï¼ˆ`IllegalStateException`ï¼‰ | âŒ å°‘ç”¨          | é˜Ÿåˆ—æ»¡å°±æŒ‚ï¼Œå½±å“ç¨³å®šæ€§          | ç®€å•ç›´æ¥        |
 * | `offer(E e)`                | âŒ éé˜»å¡  | æ·»åŠ å¤±è´¥è¿”å› `false`ï¼Œä¸æŠ›å¼‚å¸¸             | âœ… æ¨è          | å¦‚æœå¿˜è®°å¤„ç† `false`ï¼Œå¯èƒ½ä¸¢æ¶ˆæ¯ | ä¸é˜»å¡ï¼Œç¨³å®š      |
 * | `offer(E e, timeout, unit)` | â³ å¯é€‰é˜»å¡ | ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œè¶…æ—¶å¤±è´¥                     | âœ… æ¨èåœ¨é™æ—¶åœºæ™¯ç”¨    | è®¾ç½®ä¸å½“å¯èƒ½è¶…æ—¶             | å¯æ§ã€çµæ´»       |
 * | `put(E e)`                  | âœ… é˜»å¡   | é˜Ÿåˆ—æ»¡æ—¶ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æœ‰ç©ºé—´                  | âœ… æ¨èï¼ˆé™ä»»åŠ¡å¯æ§åœºæ™¯ï¼‰ | æ— æ³•åŠæ—¶ä¸­æ–­ä¼šå¡ä½çº¿ç¨‹          | å®‰å…¨ã€ç¨³å®šï¼Œé€‚åˆç”Ÿäº§è€… |
 *
 * #### ğŸš© æ³¨æ„ï¼š
 *
 * * `put()` ä¸€ç›´é˜»å¡å¯èƒ½é€ æˆâ€œçº¿ç¨‹å¡æ­»â€ã€‚
 * * `add()` ä¸é€‚åˆå¹¶å‘ä¸‹ä½¿ç”¨ï¼Œå®¹æ˜“æŠ›å¼‚å¸¸ã€‚
 *
 * ---
 *
 * ### ğŸŸ¨ å‡ºé˜Ÿæ–¹æ³•ï¼ˆè·å–å…ƒç´ ï¼‰
 *
 * | æ–¹æ³•                    | é˜»å¡æ€§    | ç‰¹æ€§                 | æ˜¯å¦æ¨è      | å¯èƒ½çš„é—®é¢˜          | ä¼˜ç‚¹        |
 * | --------------------- | ------ | ------------------ | --------- | -------------- | --------- |
 * | `poll()`              | âŒ éé˜»å¡  | æ²¡æœ‰å°±è¿”å› `null`       | âœ… æ¨è      | æ²¡æ•°æ®æ—¶å®¹æ˜“ç©ºè½®è¯¢      | å¿«é€Ÿå“åº”ï¼Œä¸é˜»å¡  |
 * | `poll(timeout, unit)` | â³ å¯é€‰é˜»å¡ | ç­‰ä¸€å®šæ—¶é—´ï¼Œæ²¡å–åˆ°è¿”å› `null` | âœ… æ¨è      | æ—¶é—´è®¾ç½®ä¸å½“ä¼šå¡ä½æˆ–å¤ªå¿«é€€å‡º | çµæ´»ã€é€‚åˆæ§åˆ¶è¶…æ—¶ |
 * | `take()`              | âœ… é˜»å¡   | é˜Ÿåˆ—ä¸ºç©ºæ—¶é˜»å¡ç­‰å¾…          | âœ… æ¨èï¼ˆæ¶ˆè´¹è€…ï¼‰ | ä¸é€€å‡ºæ—¶ä¼šä¸€ç›´æŒ‚ç€      | ç®€å•ã€æ˜“ç”¨     |
 * | `peek()`              | âŒ éé˜»å¡  | æŸ¥çœ‹å¤´å…ƒç´ ä½†ä¸ç§»é™¤          | âœ… è¾…åŠ©ä½¿ç”¨    | å¤šçº¿ç¨‹å¯èƒ½çœ‹å®Œåè¢«åˆ«äººå–èµ°  | éç ´åæ€§æŸ¥çœ‹    |
 *
 * #### ğŸš© æ³¨æ„ï¼š
 *
 * * `take()` ä¼šæ— é™é˜»å¡ï¼Œå¦‚æœä½ æ²¡è®¡åˆ’é€€å‡ºçº¿ç¨‹ï¼Œè¦å°å¿ƒâ€œæ­»ç­‰â€ã€‚
 * * `poll()` è¦æ³¨æ„å¯èƒ½ä¼šåå¤æ‹¿åˆ° nullï¼Œå¯¼è‡´â€œç©ºè½¬â€æµªè´¹ CPUã€‚
 *
 * ---
 *
 * ### ğŸŸ¦ å…¶ä»–è¾…åŠ©æ–¹æ³•
 *
 * | æ–¹æ³•                   | ç‰¹æ€§       | æ˜¯å¦çº¿ç¨‹å®‰å…¨           | å¤‡æ³¨                 |
 * | -------------------- | -------- | ---------------- | ------------------ |
 * | `size()`             | è·å–å½“å‰é˜Ÿåˆ—é•¿åº¦ | æ˜¯ï¼Œä½†å¯èƒ½ä¸å‡†ç¡®ï¼ˆç¬é—´å¯èƒ½å˜åŒ–ï¼‰ | ç”¨ä½œç›‘æ§å‚è€ƒï¼Œä¸å¯ç”¨äºæµç¨‹åˆ¤æ–­    |
 * | `clear()`            | æ¸…ç©ºæ‰€æœ‰å…ƒç´    | æ˜¯                | æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œå°å¿ƒè¯¯åˆ         |
 * | `contains(Object o)` | åˆ¤æ–­æ˜¯å¦åŒ…å«å…ƒç´  | æ˜¯                | éå†å…¨é˜Ÿåˆ—ï¼Œæ€§èƒ½ O(n)      |
 * | `toArray()`          | è½¬ä¸ºæ•°ç»„     | æ˜¯                | ä¼šå¤åˆ¶é˜Ÿåˆ—ï¼Œé¿å…å¹¶å‘ä¿®æ”¹å½±å“     |
 * | `iterator()`         | éå†å…ƒç´      | æ˜¯ï¼ˆå¼±ä¸€è‡´ï¼‰           | é€‚åˆæ—¥å¿—æˆ–å¿«ç…§ç”¨é€”ï¼Œä¸ä¿è¯å®Œæ•´å‡†ç¡®æ€§ |
 *
 * ---
 *
 * ## âš–ï¸ ä¸‰ã€æ€»ç»“å¯¹æ¯”ï¼šä½¿ç”¨æ—¶å¦‚ä½•é€‰æ‹©æ–¹æ³•ï¼Ÿ
 *
 * | åœºæ™¯         | æ¨èå…¥é˜Ÿæ–¹æ³•              | æ¨èå‡ºé˜Ÿæ–¹æ³•                     | è¯´æ˜            |
 * | ---------- | ------------------- | -------------------------- | ------------- |
 * | ä¸å…è®¸é˜»å¡ã€æ€§èƒ½ä¼˜å…ˆ | `offer(e)`          | `poll()`                   | éé˜»å¡ã€å¿«ï¼Œé€‚åˆå®æ—¶æ€§åœºæ™¯ |
 * | å…è®¸ç­‰å¾…ï¼Œæœ‰é™è¶…æ—¶  | `offer(e, timeout)` | `poll(timeout)`            | å¯æ§ï¼Œé€‚åˆé«˜åååˆéœ€è¦å®¹é”™ |
 * | æ¶ˆè´¹é€Ÿåº¦å¿…é¡»è·Ÿä¸Šç”Ÿäº§ | `put(e)`            | `take()`                   | ç®€æ´å¯é ï¼Œä½†è¦å°å¿ƒé˜»å¡   |
 * | æ—¥å¿—ã€å¯è§†åŒ–éå†   | -                   | `iterator()` / `toArray()` | éå¸¸è§„åœºæ™¯ï¼Œä¸ç”¨äºä¸šåŠ¡é€»è¾‘ |
 *
 * ---
 *
 * ## â— å¸¸è§å‘ç‚¹å’Œæ³¨æ„äº‹é¡¹
 *
 * ### 1. `take()` / `put()` é˜»å¡çº¿ç¨‹
 *
 * å¦‚æœé˜Ÿåˆ—æ°¸è¿œæ»¡/ç©ºï¼Œè°ƒç”¨è¿™äº›æ–¹æ³•çš„çº¿ç¨‹ä¼š**ä¸€ç›´æŒ‚ä½**ï¼Œè¦å°å¿ƒçº¿ç¨‹èµ„æºè€—å°½ã€‚
 *
 * ### 2. `size()` æ˜¯ç¬æ—¶çš„
 *
 * åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œè¿™ä¸ªæ–¹æ³•**ä¸èƒ½ç”¨äºæµç¨‹æ§åˆ¶é€»è¾‘**ï¼Œå› ä¸ºå€¼å¯èƒ½è¿‡æ—¶ã€‚
 *
 * ### 3. ä½¿ç”¨ `offer` è¦åˆ¤æ–­è¿”å›å€¼
 *
 * å¦åˆ™æ•°æ®å¯èƒ½æ‚„æ‚„â€œä¸¢å¤±â€ï¼Œè€Œä½ ä»¥ä¸ºå®ƒåŠ è¿›å»äº†ã€‚
 *
 * ### 4. å¤šçº¿ç¨‹éå†æ³¨æ„ä¸€è‡´æ€§
 *
 * è™½ç„¶ `iterator()` æ˜¯â€œå¼±ä¸€è‡´â€ï¼Œä½†ä»ç„¶ä¸èƒ½ç”¨äºâ€œä¿®æ”¹é€»è¾‘â€ï¼Œåªé€‚åˆç›‘æ§ç”¨é€”ã€‚
 *
 * ---
 *
 * ## âœ… å¦‚æœä½ è¦åº”ç”¨åˆ°é¡¹ç›®ä¸­
 *
 * * æ¨èæ­é… `ExecutorService + LinkedBlockingQueue` æ„é€ çº¿ç¨‹æ± ï¼›
 * * æˆ–ç”¨äº `ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹`ï¼›
 * * æƒ³æ€§èƒ½æ›´é«˜ã€å†…å­˜å¼€é”€æ›´å°çš„é˜Ÿåˆ—ï¼Œå¯ä»¥è€ƒè™‘ï¼š
 *
 *   * `ArrayBlockingQueue`ï¼ˆæ•°ç»„ç»“æ„ï¼‰
 *   * `Disruptor`ï¼ˆé«˜æ€§èƒ½ï¼‰
 *
 * ---
 *
 * å¦‚æœä½ å¸Œæœ›æˆ‘ç»“åˆå…·ä½“ä»£ç åœºæ™¯ï¼ˆæ¯”å¦‚çº¿ç¨‹æ± ã€è‡ªå®šä¹‰æ¶ˆè´¹è€…æ¨¡å‹ç­‰ï¼‰ä¸¾ä¾‹è¯´æ˜è¿™äº›æ–¹æ³•æ€ä¹ˆé…åˆä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥ç»™ä½ ä¸€ä»½ç»“æ„å®Œæ•´çš„é¡¹ç›®ç¤ºä¾‹ä»£ç ã€‚
 */
