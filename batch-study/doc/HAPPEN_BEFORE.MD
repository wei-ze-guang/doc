##  ä»€ä¹ˆæ˜¯happens-before  
happens-beforeâ€ æ˜¯ Java å†…å­˜æ¨¡å‹ï¼ˆJava Memory Model, JMMï¼‰ ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒæ˜¯ Java ä¿è¯å¤šçº¿ç¨‹é—´å¯è§æ€§å’Œæœ‰åºæ€§çš„ç†è®ºåŸºç¡€ã€‚

ä¸€ã€å®ƒå±äºä»€ä¹ˆï¼Ÿ  
- å±äºï¼šJava Memory Modelï¼ˆJMMï¼‰    
- å®ç°ä¾èµ–ï¼šJVM ä¸ç¡¬ä»¶ï¼ˆCPUã€ç¼“å­˜ä¸€è‡´æ€§ã€å†…å­˜å±éšœç­‰ï¼‰  
- ä¸å±äº Java è¯­è¨€è¯­æ³•ï¼Œä¹Ÿä¸æ˜¯ JVM ç‹¬ç«‹è§„èŒƒï¼Œè€Œæ˜¯ JMM çš„æ ¸å¿ƒè¯­ä¹‰è§„åˆ™ï¼Œç”¨æ¥å®šä¹‰â€œä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§â€çš„å‰æã€‚  
---  
ğŸ§  äºŒã€ä¸ºä»€ä¹ˆéœ€è¦ happens-beforeï¼Ÿ
- åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼ŒCPU å‡ºäºæ€§èƒ½è€ƒè™‘å¯èƒ½ä¼šï¼š
  - ä¹±åºæ‰§è¡ŒæŒ‡ä»¤
  - ç¼“å­˜å˜é‡è€Œä¸å†™å›ä¸»å†…å­˜
  - å¯¼è‡´æŸäº›çº¿ç¨‹çœ‹åˆ°çš„æ˜¯æ—§æ•°æ®æˆ–æœªåˆå§‹åŒ–çŠ¶æ€
  - ä¸ºäº†è§£å†³è¿™äº›â€œçœ‹ä¸è§â€æˆ–â€œä¹±é¡ºåºâ€çš„é—®é¢˜ï¼ŒJava å®šä¹‰äº†â€œhappens-before å…³ç³»â€ï¼Œç”¨æ¥åˆ¤æ–­ï¼š
  - ä¸€ä¸ªæ“ä½œæ˜¯å¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Ÿæ‰§è¡Œé¡ºåºæ˜¯å¦æœ‰ä¿éšœï¼Ÿ  
## ã€happens-before çš„å…«å¤§è§„åˆ™ï¼ˆJMMå®šä¹‰ï¼‰
| è§„åˆ™ç¼–å· | happens-before è§„åˆ™ | é€šä¿—è§£é‡Š                                                             |
| ---- | ----------------- | ---------------------------------------------------------------- |
| 1    | ç¨‹åºé¡ºåºè§„åˆ™            | åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå‰é¢çš„æ“ä½œ happens-before åé¢çš„æ“ä½œ                                |
| 2    | ç›‘è§†å™¨é”è§„åˆ™            | ä¸€ä¸ªè§£é” unlock å‘ç”Ÿåœ¨åé¢å¯¹åŒä¸€é”çš„åŠ é” lock ä¹‹å‰                                 |
| 3    | volatile è§„åˆ™       | å¯¹ volatile å˜é‡çš„å†™æ“ä½œ happens-before åç»­çš„è¯»æ“ä½œ                          |
| 4    | çº¿ç¨‹å¯åŠ¨è§„åˆ™            | `Thread.start()` ä¹‹å‰çš„æ“ä½œï¼Œå¯¹æ–°çº¿ç¨‹å¯è§                                    |
| 5    | çº¿ç¨‹ç»ˆæ­¢è§„åˆ™            | ä¸€ä¸ªçº¿ç¨‹çš„æ‰€æœ‰æ“ä½œ happens-before `Thread.join()` è¿”å›                      |
| 6    | çº¿ç¨‹ä¸­æ–­è§„åˆ™            | å¯¹çº¿ç¨‹ `interrupt()` è°ƒç”¨ happens-before çº¿ç¨‹æ£€æµ‹åˆ°ä¸­æ–­                      |
| 7    | å¯¹è±¡æ„é€ è§„åˆ™            | æ„é€ å‡½æ•°ä¸­çš„æ“ä½œï¼Œå¯¹æ„é€ å®Œæˆçš„å¯¹è±¡å¯è§ï¼ˆå‰æï¼šthis æ²¡é€¸å‡ºï¼‰                                 |
| 8    | ä¼ é€’æ€§               | å¦‚æœ A happens-before Bï¼Œä¸” B happens-before Cï¼Œé‚£ä¹ˆ A happens-before C |  
### ç¨‹åºé¡ºåºè§„åˆ™
```java
int a = 1;       // å…ˆæ‰§è¡Œ
int b = a + 1;   // åæ‰§è¡Œï¼Œä¸”èƒ½çœ‹åˆ° a = 1
```  
- ä¿è¯çº¿ç¨‹å†… ä»£ç è¯­ä¹‰ä¸€è‡´æ€§  
---  
- 2ï¸âƒ£ ç›‘è§†å™¨é”è§„åˆ™ï¼ˆsynchronizedï¼‰
```java
synchronized (lock) {
sharedVar = 100; // çº¿ç¨‹Aå†™
        }
// ------
synchronized (lock) {
        System.out.println(sharedVar); // çº¿ç¨‹Bè¯»
}
```
âœ… çº¿ç¨‹Aé‡Šæ”¾é”åï¼Œçº¿ç¨‹Bè·å–åŒä¸€æŠŠé”ï¼Œèƒ½ çœ‹åˆ° A å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ã€‚
**âœ… çº¿ç¨‹Aé‡Šæ”¾é”åï¼Œçº¿ç¨‹Bè·å–åŒä¸€æŠŠé”ï¼Œèƒ½çœ‹åˆ° A å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ã€‚**  
---  
### volatile å˜é‡è§„åˆ™  
```java
volatile boolean flag = false;

// çº¿ç¨‹1
flag = true;

// çº¿ç¨‹2
if (flag) {
    // èƒ½çœ‹åˆ°çº¿ç¨‹1çš„ä¿®æ”¹
}

```
âœ… å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹åç»­è¯»å¯è§ã€‚  
âš ï¸ åªä¿è¯ å¯è§æ€§ å’Œ ç¦æ­¢é‡æ’åºï¼Œä¸ä¿è¯åŸå­æ€§ã€‚  
---  

###  çº¿ç¨‹å¯åŠ¨è§„åˆ™  
```java
int a = 1;
Thread t = new Thread(() -> {
    System.out.println(a); // âœ… èƒ½çœ‹åˆ°ä¸»çº¿ç¨‹ä¸­è®¾ç½®çš„ a=1
});
t.start();

```
**âœ… ä¸»çº¿ç¨‹åœ¨ start() å‰çš„æ“ä½œï¼Œå¯¹å­çº¿ç¨‹å¯è§ã€‚**  
---  
  
### çº¿ç¨‹ç»ˆæ­¢è§„åˆ™  
```java
Thread t = new Thread(() -> {
    result = compute(); // çº¿ç¨‹å†™å˜é‡
});
t.start();
t.join(); // é˜»å¡ç­‰å¾…çº¿ç¨‹å®Œæˆ
System.out.println(result); // âœ… çº¿ç¨‹tçš„å†™å¯¹ä¸»çº¿ç¨‹å¯è§  
```  
join() ä¿è¯å­çº¿ç¨‹æ“ä½œå¯¹ä¸»çº¿ç¨‹å¯è§ã€‚**

---  
### ä¸­æ–­è§„åˆ™  
```java
// çº¿ç¨‹A
t.interrupt();

// çº¿ç¨‹B
if (Thread.currentThread().isInterrupted()) {
    // âœ… èƒ½æ£€æµ‹åˆ°ä¸­æ–­
}

```  
**âœ… interrupt çš„è°ƒç”¨å¯¹ç›®æ ‡çº¿ç¨‹æ£€æµ‹ä¸­æ–­å¯è§ã€‚**

---

### æ„é€ è§„åˆ™ï¼ˆConstruction Ruleï¼‰æ˜¯ Java Memory Modelï¼ˆJMMï¼‰ä¸­ **happens-before** çš„ç¬¬ 7 æ¡è§„åˆ™ï¼Œæ„æ€æ˜¯ï¼š  
è¿™é‡Œå’Œ**final**å…³é”®å­—å…³ç³»å¾ˆå¤§,ä¸€ä¸ªå˜é‡å°±æ˜¯è®©å˜é‡åœ¨æ„é€ å™¨æ–¹æ³•ä¸­å¿…å®šæ¯”thisèµ‹å€¼

> âœ… **ä¸€ä¸ªå¯¹è±¡çš„æ„é€ æ–¹æ³•ä¸­çš„æ‰€æœ‰å†™æ“ä½œï¼Œhappens-before å…¶ä»–çº¿ç¨‹è·å–è¯¥å¯¹è±¡å¼•ç”¨åçš„è¯»æ“ä½œã€‚**

æ¢å¥è¯è¯´ï¼š

ğŸ§  é€šä¿—è§£é‡Šï¼š

å½“ä½ åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ç”¨ `new` æ„é€ ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶æŠŠè¿™ä¸ªå¯¹è±¡å‘å¸ƒï¼ˆèµ‹å€¼ï¼‰ç»™å…¶ä»–çº¿ç¨‹æ—¶ï¼š

* **åªè¦å¯¹è±¡æ„é€ â€œæ²¡æœ‰å‘ç”Ÿ this é€ƒé€¸â€**ï¼Œ
* é‚£ä¹ˆæ„é€ æ–¹æ³•é‡Œå†™å…¥çš„æ‰€æœ‰å­—æ®µå€¼ï¼Œ**å…¶ä»–çº¿ç¨‹éƒ½èƒ½çœ‹åˆ°æœ€æ–°çš„å€¼**ã€‚

ğŸ“¦ ä¸¾ä¸ªä¾‹å­ï¼ˆâœ… æ­£ç¡®ï¼‰

```java
class Person {
    int age;

    Person() {
        age = 18; // åˆå§‹åŒ–
    }
}

public class Demo {
    static Person person;

    public static void main(String[] args) throws Exception {
        Thread t1 = new Thread(() -> {
            person = new Person();  // å¯¹è±¡æ„é€ å®Œåèµ‹å€¼
        });

        Thread t2 = new Thread(() -> {
            while (person == null); // ç­‰å¾…æ„é€ å®Œæˆ
            System.out.println(person.age); // è¿™é‡Œèƒ½çœ‹åˆ° 18
        });

        t1.start();
        t2.start();
    }
}
```

âœ… è™½ç„¶æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½† `t2` ä¸­è¯»å– `person.age` ä¸€å®šèƒ½çœ‹åˆ°æ„é€ æ–¹æ³•é‡Œè®¾çš„ `18`ï¼Œå› ä¸º `æ„é€ æ–¹æ³•çš„å†™ â†’ è·å–å¼•ç”¨çš„è¯»` æ˜¯ä¸€ä¸ª happens-beforeã€‚


âš ï¸ é”™è¯¯ä¾‹å­ï¼šthis é€¸å‡ºï¼ˆæ„é€ è¿‡ç¨‹æœªå®Œæˆå°±å‘å¸ƒï¼‰

```java
class Bad {
    static Bad instance;
    int num;

    public Bad() {
        instance = this; // âŒ this é€ƒé€¸
        num = 42;        // åæ‰§è¡Œ
    }
}
```

å‡å¦‚å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ `Bad.instance` è·å–å¯¹è±¡ï¼Œç”±äº `this` æå‰æš´éœ²ï¼Œçº¿ç¨‹å¯èƒ½ä¼šï¼š

* æ‹¿åˆ°ä¸€ä¸ªæ„é€ è¿˜æ²¡æ‰§è¡Œå®Œçš„å¯¹è±¡ï¼›
* çœ‹åˆ° `num = 0` è€Œä¸æ˜¯ `42`ï¼›
* å¯¼è‡´ â€œåŠåˆå§‹åŒ–â€ çŠ¶æ€ï¼ˆå¾ˆå±é™©ï¼‰ã€‚

 âœ… æ„é€ è§„åˆ™æ€»ç»“ï¼š

| ç‰¹ç‚¹ | æè¿°                     |
| -- | ---------------------- |
| æ‰€å± | happens-before è§„åˆ™ç¬¬ 7 æ¡ |
| æ¡ä»¶ | å¯¹è±¡ä¸èƒ½åœ¨æ„é€ è¿‡ç¨‹ä¸­â€œé€¸å‡ºâ€         |
| æ„ä¹‰ | ä¿è¯æ„é€ æ–¹æ³•ä¸­çš„èµ‹å€¼å¯¹å…¶ä»–çº¿ç¨‹å¯è§      |
| åº”ç”¨ | å•ä¾‹æ¨¡å¼ã€å®‰å…¨å‘å¸ƒå¯¹è±¡            |


ğŸ”¥ é¢è¯•é‡ç‚¹ï¼šæ„é€ è§„åˆ™ + å•ä¾‹æ¨¡å¼

åœ¨åŒé‡æ£€æŸ¥é”ï¼ˆDCLï¼‰ä¸­ï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```java
private static volatile Singleton instance;

public static Singleton getInstance() {
    if (instance == null) {
        synchronized (Singleton.class) {
            if (instance == null) {
                instance = new Singleton(); // æ„é€  + volatile ä¿è¯å¯è§
            }
        }
    }
    return instance;
}
```

> âœ… è¿™é‡Œçš„ `volatile` æ˜¯ä¸ºäº†é…åˆæ„é€ è§„åˆ™é˜²æ­¢åŠåˆå§‹åŒ–ï¼Œé˜²æ­¢ CPU æŒ‡ä»¤é‡æ’ã€‚

---  
### ä¼ é€’æ€§
  A happens-before Bï¼ŒB happens-before Cï¼Œåˆ™ A happens-before Cã€‚
  ä¾‹å¦‚ï¼š
  - volatile write â†’ volatile read â†’ æ™®é€šè¯»å†™
  - unlock â†’ lock â†’ æ“ä½œ
  - âœ… è¿™ä½¿å¾—å¤šæ­¥éª¤åŒæ­¥æˆä¸ºå¯èƒ½ã€‚  
---



