| ç‰¹æ€§å¯¹æ¯”    | `CountDownLatch`        | `CyclicBarrier`                |
| ------- |-------------------------| ------------------------------ |
| åˆå§‹ä½œç”¨    | **ç­‰å¾…â€œäº‹ä»¶å‘ç”Ÿæ¬¡æ•°â€**          | **ç­‰å¾…â€œçº¿ç¨‹æ•°é‡â€**                   |
| å…¸å‹ç”¨é€”    | ç­‰å¾…ä¸€ç»„ä»»åŠ¡æ‰§è¡Œå®Œåå†ç»§ç»­           | å¤šçº¿ç¨‹â€œé›†åˆç‚¹â€åå†ä¸€èµ·å‰è¿›                 |
| èƒ½å¦é‡å¤ä½¿ç”¨ï¼Ÿ | âŒ åªç”¨ä¸€æ¬¡ï¼Œé‡å¤ä½¿ç”¨å°±è¦é‡æ–°åˆ›å»º       | âœ… å¯å¤šæ¬¡å¾ªç¯ä½¿ç”¨                      |
| å®ç°æœºåˆ¶    | AQSï¼ˆå…±äº«æ¨¡å¼ï¼‰               | åŸºäº `ReentrantLock + Condition` |
| ç­‰å¾…è°/ä»€ä¹ˆï¼Ÿ | ä¸»çº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹ `countDown()` | æ‰€æœ‰çº¿ç¨‹ç›¸äº’ç­‰å¾…ï¼ˆéƒ½å¿…é¡»åˆ°è¾¾ï¼‰                |  
---  


## âœ… CountDownLatch åœºæ™¯ï¼šç­‰å…¶ä»–çº¿ç¨‹å¹²å®Œäº‹ï¼Œprivate volatile int state;è¿™ä¸ªæ•°é‡ç”¨æ¥ç»Ÿè®¡çš„ï¼Œæ„é€ æ–¹æ³•ä¼ å…¥
```java
CountDownLatch latch = new CountDownLatch(3);  //stateåˆå§‹åŒ–ä¸º1

for (int i = 0; i < 3; i++) {
    new Thread(() -> {
        doWork();
        latch.countDown(); // é€šçŸ¥ä¸»çº¿ç¨‹ï¼šæˆ‘å¹²å®Œäº†,stateæ•°é‡å‡1
    }).start();
}

latch.await(); // ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹éƒ½å®Œæˆï¼Œç­‰å¾… state == 0 å˜æˆ 0 æ‰è¿”å› ï¼Œè¿™é‡Œä¼šæŒ‚èµ·ä¸»çº¿ç¨‹ï¼Œä¸º0çš„è¯å°±ä¼šå”¤é†’
System.out.println("æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œç»§ç»­æ‰§è¡Œä¸»çº¿ç¨‹");

```  
**ğŸ§  ç±»æ¯”ï¼šä½ ç­‰ 3 ä¸ªå¤–å–å‘˜é€é¤ï¼Œé€å®Œä½ å°±å¼€é¥­ï¼Œä¸ç®¡ä»–ä»¬è°å…ˆåˆ°ï¼Œä¹Ÿä¸é‡å¤**  ---  
CountDownLatch å°±æ˜¯å®šä¹‰ä¸€ä¸ªstateï¼Œåªè¦è¿™ä¸ªæ•°é‡å˜ä¸º0ï¼Œå¦‚æœå“ªä¸€ä¸ªçº¿ç¨‹å†…è°ƒç”¨äº†latch.await();æ–¹æ³•ï¼Œå¿…é¡»ç­‰åˆ°state  
å˜ä¸º0æ‰ä¼šè¢«å”¤é†’ï¼Œä¸ç®¡é¡ºåºï¼Œåªç®¡æ•°é‡


## CyclicBarrier æ˜¯ Java å¹¶å‘å·¥å…·åŒ…ä¸­ä¸€ä¸ªéå¸¸å®ç”¨çš„â€œåŒæ­¥å±éšœâ€ï¼Œå®ƒå…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°å…¨éƒ¨çº¿ç¨‹éƒ½å‡†å¤‡å°±ç»ªï¼Œå†ä¸€èµ·ç»§ç»­æ‰§è¡Œã€‚å®ƒé€‚åˆåˆ†é˜¶æ®µå¹¶è¡Œã€ä»»åŠ¡åè°ƒã€å¤šçº¿ç¨‹åŒæ­¥å¯åŠ¨ç­‰åœºæ™¯ã€‚
ğŸ§  ä¸€å¥è¯ç†è§£ï¼š
â€œç­‰å¤§å®¶éƒ½åˆ°äº†å†å‡ºå‘â€â€”â€”æ‰€æœ‰çº¿ç¨‹å¿…é¡»åœ¨å±éšœå‰é›†åˆï¼Œé›†åˆæ»¡äº†æ‰ä¸€èµ·ç»§ç»­æ‰§è¡Œï¼ é€šè¿‡å›è°ƒ 
| åº”ç”¨åœºæ™¯              | ç¤ºä¾‹è¯´æ˜                      |
| ----------------- | ------------------------- |
| å¤šçº¿ç¨‹å¹¶è¡Œè®¡ç®—ï¼Œæ±‡æ€»ç»“æœ      | æ¯ä¸ªçº¿ç¨‹è®¡ç®—ä¸€éƒ¨åˆ†æ•°æ®ï¼Œæ±‡æ€»å‰éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ |
| å¤šé˜¶æ®µæ¸¸æˆï¼ˆå¦‚å‰¯æœ¬åŒ¹é…ã€ç»„é˜Ÿï¼‰   | æ‰€æœ‰ç©å®¶åŠ è½½å®Œå†ç»Ÿä¸€å¼€å§‹æˆ˜æ–—            |
| æ¨¡æ‹Ÿæ¥åŠ›èµ›ï¼Œæ¯ä¸€é˜¶æ®µå®Œæˆåä¸€èµ·å‡ºå‘ | æ¯ä¸ªçº¿ç¨‹è¡¨ç¤ºä¸€ä¸ªè¿åŠ¨å‘˜ï¼Œå¿…é¡»ç­‰ä¸Šä¸€ä¸ªé˜¶æ®µå…¨éƒ¨å®Œæˆ  |
| ç§‘ç ”æ¨¡æ‹Ÿæˆ–å¤šé˜¶æ®µæµç¨‹ï¼ˆå¦‚ä»¿çœŸå™¨ï¼‰  | æ¯é˜¶æ®µéƒ½å¿…é¡»ç»Ÿä¸€æ­¥è°ƒæ‰èƒ½ç»§ç»­            |
---  
```java
import java.util.concurrent.BrokenBarrierException;
import java.util.concurrent.CyclicBarrier;

public class CyclicBarrierDemo {
    public static void main(String[] args) {
        // è®¾ç½®å±éšœç‚¹ä¸º 3ï¼Œæ‰€æœ‰çº¿ç¨‹åˆ°è¾¾åæ‰§è¡Œ barrierAction
        CyclicBarrier barrier = new CyclicBarrier(3, () -> {
            System.out.println("æ‰€æœ‰çº¿ç¨‹éƒ½å‡†å¤‡å¥½äº†ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼");
        });

        for (int i = 1; i <= 3; i++) {
            int threadId = i;
            new Thread(() -> {
                System.out.println("çº¿ç¨‹ " + threadId + " æ­£åœ¨å‡†å¤‡...");
                try {
                    Thread.sleep(1000 * threadId); // æ¨¡æ‹Ÿå‡†å¤‡æ—¶é—´ä¸åŒ
                    System.out.println("çº¿ç¨‹ " + threadId + " å‡†å¤‡å®Œæ¯•ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹...");
                    barrier.await(); // â— ç­‰å¾…å…¶ä»–çº¿ç¨‹
                    System.out.println("çº¿ç¨‹ " + threadId + " æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼");
                } catch (InterruptedException | BrokenBarrierException e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}

```  
CyclicBarrier åº•å±‚æ²¡æœ‰ä½¿ç”¨ AQSï¼Œè€Œæ˜¯ä½¿ç”¨äº†ï¼š ReentrantLock + Condition å†…éƒ¨æœ‰ä¸€ä¸ªè®¡æ•°å™¨ countï¼Œåˆå§‹ä¸ºæ„é€ æ—¶è®¾ç½®çš„çº¿ç¨‹æ•° parties  
æ¯æ¬¡è°ƒç”¨ await()ï¼Œå°±å°† count-- å¦‚æœ count > 0ï¼Œå½“å‰çº¿ç¨‹é˜»å¡ å¦‚æœ count == 0ï¼Œè¡¨ç¤ºæœ€åä¸€ä¸ªçº¿ç¨‹åˆ°äº†ï¼Œæ‰€æœ‰é˜»å¡çº¿ç¨‹ä¸€èµ·å”¤é†’ ç„¶åè‡ªåŠ¨é‡ç½®è®¡æ•°å™¨ä¸ºåŸå§‹å€¼ï¼Œå¯å†æ¬¡ä½¿ç”¨  
è¿™å°±æ˜¯å®ƒå« â€œCyclicâ€ çš„åŸå› ï¼šå¾ªç¯å¯å¤ç”¨  

###  ä¸‹é¢æ˜¯å¤ç”¨çš„æ¡ˆä¾‹
```java
package countbarrier;

import java.util.concurrent.BrokenBarrierException;
import java.util.concurrent.CyclicBarrier;

public class CyclicBarrierReuseDemo {

    static final int parties = 3;
    static  CyclicBarrier barrier = new CyclicBarrier(parties, () -> {
        System.out.println(">>> æ‰€æœ‰äººåˆ°è¾¾å±éšœç‚¹ï¼Œå¼€å§‹ä¸‹ä¸€é˜¶æ®µ\n");
    });
    //ä¸Šé¢è§¦å‘ä¹‹åbarrier ä¼šå›åˆ°åŸæ¥çš„çŠ¶æ€ï¼Œå¯ä»¥é‡å¤ä½¿ç”¨ï¼Œæ¯”å¦‚ä¸Šé¢çš„åˆå˜å‘³äº†3

    public static void main(String[] args) {

        for (int i = 0; i < parties; i++) {
            new Thread(new Worker(barrier, i)).start();
        }

    }
    static class Worker implements Runnable {

        private final CyclicBarrier cyclicBarrier;

        private final int id;

        public Worker(CyclicBarrier cyclicBarrier, int id) {
            this.cyclicBarrier = cyclicBarrier;
            this.id = id;
        }

        @Override
        public void run() {
            try {
                for (int round = 1; round <= 3; round++) {
                    System.out.println("çº¿ç¨‹ " + id + " ç¬¬ " + round + " è½®å‡†å¤‡...");
                    Thread.sleep((long)(Math.random() * 1000)); // æ¨¡æ‹Ÿä»»åŠ¡
                    System.out.println("çº¿ç¨‹ " + id + " ç¬¬ " + round + " è½®å°±ç»ªï¼Œç­‰å¾…å…¶ä»–äºº...");
                    barrier.await(); // æ¯ä¸€è½®éƒ½åŒæ­¥ä¸€æ¬¡ ç¬¬ä¸€æ¬¡å¾ªç¯è°ƒç”¨çš„æ—¶å€™ï¼Œå°±å·²ç»å¡åœ¨è¿™é‡Œäº†ï¼Œ
                }
            } catch (InterruptedException | BrokenBarrierException e) {
                e.printStackTrace();
            }
        }
    }
}

```  
## ä¸€ã€ä»€ä¹ˆæ˜¯ Semaphoreï¼Ÿ
Semaphoreï¼ˆä¿¡å·é‡ï¼‰æ˜¯ java.util.concurrent ä¸­çš„ä¸€ä¸ªç”¨äºæ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„å¹¶å‘å·¥å…·ç±»ï¼Œåº•å±‚åŸºäº AQS å®ç°ã€‚  
æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼šæ§åˆ¶æœ€å¤šæœ‰å¤šå°‘ä¸ªçº¿ç¨‹èƒ½åŒæ—¶è®¿é—®æŸä¸ªèµ„æºã€‚  
---  
| æ„é€ æ–¹æ³•                                   | è¯´æ˜                                             |
| -------------------------------------- | ---------------------------------------------- |
| `Semaphore(int permits)`               | åˆ›å»ºä¸€ä¸ª**éå…¬å¹³ä¿¡å·é‡**ï¼Œæœ€å¤šå…è®¸ `permits` ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®èµ„æº        |
| `Semaphore(int permits, boolean fair)` | åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œ`fair = true` è¡¨ç¤ºä½¿ç”¨ **å…¬å¹³é”** ç­–ç•¥ï¼ˆFIFO é¡ºåºï¼‰ |
---  
| æ–¹æ³•                                                     | æ˜¯å¦é˜»å¡  | æè¿°                      |
| ------------------------------------------------------ | ----- |-------------------------|
| `acquire()`                                            | âœ… æ˜¯   | è¯·æ±‚ä¸€ä¸ªè®¸å¯è¯ï¼Œæ²¡æœ‰å°±é˜»å¡           |
| `acquire(int permits)`                                 | âœ… æ˜¯   | è¯·æ±‚å¤šä¸ªè®¸å¯è¯                 |
| `acquireUninterruptibly()`                             | âœ… æ˜¯   | è¯·æ±‚ä¸€ä¸ªè®¸å¯è¯ï¼Œä½†ä¸å¯ä¸­æ–­           |
| `tryAcquire()`                                         | âŒ å¦   | å°è¯•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œå¤±è´¥å°±è¿”å› `false` |
| `tryAcquire(int permits)`                              | âŒ å¦   | å°è¯•è·å–å¤šä¸ªè®¸å¯è¯               |
| `tryAcquire(long timeout, TimeUnit unit)`              | â³ å¯é˜»å¡ | å°è¯•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´        |
| `tryAcquire(int permits, long timeout, TimeUnit unit)` | â³ å¯é˜»å¡ | å°è¯•è·å–å¤šä¸ªè®¸å¯è¯ï¼Œå¸¦è¶…æ—¶           |
| `release()`                                            | âŒ å¦   | é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯ï¼ˆé€šçŸ¥å…¶ä»–çº¿ç¨‹ï¼‰,æ³¨æ„ä¸‹é¢çš„   |
| `release(int permits)`                                 | âŒ å¦   | é‡Šæ”¾å¤šä¸ªè®¸å¯è¯                 |
| `availablePermits()`                                   | âŒ å¦   | å½“å‰å¯ç”¨çš„è®¸å¯è¯æ•°é‡              |
| `drainPermits()`                                       | âŒ å¦   | ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å‰©ä½™çš„è®¸å¯è¯ï¼ˆå˜ä¸º 0ï¼‰     |
| `reducePermits(int reduction)`                         | âŒ å¦   | å‡å°‘æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼ˆæ…ç”¨ï¼‰          |
| `isFair()`                                             | âŒ å¦   | æ˜¯å¦æ˜¯å…¬å¹³é”ç­–ç•¥                |
| `hasQueuedThreads()`                                   | âŒ å¦   | æ˜¯å¦æœ‰çº¿ç¨‹åœ¨ç­‰å¾…è®¸å¯              |
---  
| æ“ä½œ                                  | æ˜¯å¦å…è®¸ | æ¨èå—                 |
| ----------------------------------- | ---- |---------------------|
| æ‹¿ 1 æ”¾ 1 (`acquire() + release()`)   | âœ…    | âœ… æ¨è                |
| æ‹¿ 2 æ”¾ 2 (`acquire(2) + release(2)`) | âœ…    | âœ… æ¨è                |
| æ‹¿ 1 æ”¾ 2 (`acquire() + release(2)`)  | âœ…    | âŒ ä¸æ¨èï¼ˆä¼šå¯¼è‡´å¤šæ”¾ï¼‰ä¼šå¤šå‡ºæ¥é€šè¡Œè¯ |
| æ‹¿ 1 æ”¾ 0 (`acquire() + ä¸é‡Šæ”¾`)         | âœ…    | âŒ ä¸æ¨èï¼ˆä¼šæ­»é”ï¼‰          |
---  

- acquire()ï¼šåº•å±‚è°ƒç”¨ AQS çš„ tryAcquireShared() æ–¹æ³•ï¼Œå°è¯•æ‰£å‡è®¸å¯è¯æ•°ã€‚
- release()ï¼šåº•å±‚è°ƒç”¨ AQS çš„ releaseShared() æ–¹æ³•ï¼Œå¢åŠ è®¸å¯å¹¶å”¤é†’ç­‰å¾…çº¿ç¨‹ã€‚
- AQS ç»´æŠ¤ä¸€ä¸ªå…±äº«è®¡æ•°å™¨ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«é€šè¿‡ï¼ˆä¸åƒäº’æ–¥é”é‚£æ ·åªå…è®¸ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚  
---  
åœºæ™¯ï¼šä¸Šå•æ‰€æ¨¡å‹ï¼ˆé™åˆ¶èµ„æºè®¿é—®ï¼‰  
```java
Semaphore semaphore = new Semaphore(3); // æ¨¡æ‹Ÿ 3 ä¸ªå•æ‰€

Runnable person = () -> {
    try {
        semaphore.acquire(); // è¯·æ±‚ä¸Šå•æ‰€ï¼ˆè‹¥æ²¡å‘ä½ï¼Œåˆ™æ’é˜Ÿç­‰ï¼‰
        System.out.println(Thread.currentThread().getName() + " å ç”¨å•æ‰€");
        Thread.sleep(3000); // ä¸Šå•æ‰€ä¸­...
        System.out.println(Thread.currentThread().getName() + " ç¦»å¼€å•æ‰€");
    } catch (InterruptedException e) {
        e.printStackTrace();
    } finally {
        semaphore.release(); // ç¦»å¼€åé‡Šæ”¾å‘ä½
    }
};

for (int i = 1; i <= 10; i++) {
    new Thread(person, "äºº" + i).start();
}

```  
## ä½¿ç”¨åœºæ™¯
- é™æµï¼ˆRate Limitingï¼‰ï¼šæ§åˆ¶ç³»ç»Ÿä¸­åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°  
- æ•°æ®åº“è¿æ¥æ± ï¼šé™åˆ¶åŒæ—¶è¿æ¥çš„çº¿ç¨‹æ•°é‡
- æ“ä½œç³»ç»Ÿèµ„æºä¿æŠ¤ï¼šå¦‚ I/O é™åˆ¶ã€çº¿ç¨‹æ± å®¹é‡æ§åˆ¶
- é«˜å¹¶å‘é™é€Ÿï¼šå…è®¸ä¸€å®šå¹¶å‘çº¿ç¨‹ï¼Œå…¶ä½™ç­‰å¾…è®¸å¯
- è¯»å†™é™é‡è®¿é—®ï¼šæ¯”å¦‚é™åˆ¶åªæœ‰ 5 ä¸ªçº¿ç¨‹èƒ½è¯»å–æŸä¸ªæ–‡ä»¶

